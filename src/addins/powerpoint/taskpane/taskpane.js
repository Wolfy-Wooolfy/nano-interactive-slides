import { createEngine } from "../../../../packages/simulation-engine/src/index.js";
let engine=null;let nanoOn=false;const q=s=>document.querySelector(s);function setBox(obj){q("#state-box").textContent=JSON.stringify(obj,null,2)}function defaultScenario(){return{nodes:[{id:"factory",type:"producer",rate:5},{id:"warehouse",type:"buffer",capacity:50},{id:"store",type:"consumer",rate:4}],edges:[{from:"factory",to:"warehouse",delay:2},{from:"warehouse",to:"store",delay:1}],params:{tickMs:100,initialStock:{factory:0,warehouse:10,store:0}}}}function scenarioFromInputs(){return{nodes:[{id:"factory",type:"producer",rate:Number(q("#inp-factory").value)},{id:"warehouse",type:"buffer",capacity:Number(q("#inp-warehouse").value)},{id:"store",type:"consumer",rate:Number(q("#inp-store").value)}],edges:[{from:"factory",to:"warehouse",delay:Number(q("#inp-dfw").value)},{from:"warehouse",to:"store",delay:Number(q("#inp-dws").value)}],params:{tickMs:Number(q("#inp-tick").value),initialStock:{factory:0,warehouse:10,store:0}}}}function applyInputs(){const p={tickMs:Number(q("#inp-tick").value),speed:Number(q("#inp-speed").value),factoryRate:Number(q("#inp-factory").value),warehouseCapacity:Number(q("#inp-warehouse").value),storeRate:Number(q("#inp-store").value),delayFactoryToWarehouse:Number(q("#inp-dfw").value),delayWarehouseToStore:Number(q("#inp-dws").value)};engine.setParams(p)}function bindInputs(){["inp-tick","inp-speed","inp-factory","inp-warehouse","inp-store","inp-dfw","inp-dws"].forEach(id=>{q("#"+id).addEventListener("input",applyInputs)})}function initEngine(){const scn=defaultScenario();engine=createEngine({stock:{factory:0,warehouse:10,store:0}},{});engine.loadScenario(scn);engine.onUpdate(({state,params})=>{setBox({stock:state.stock,params})})}function toggleNano(){nanoOn=!nanoOn;q("#nano-panel").style.display=nanoOn?"block":"none";if(nanoOn){startParallax()}else{stopParallax()}}let rafId=null;function startParallax(){const el=q("#nano-stage");el.innerHTML="";const a=document.createElement("div");const b=document.createElement("div");const c=document.createElement("div");[a,b,c].forEach(x=>{x.style.position="absolute";x.style.top="0";x.style.left="0";x.style.right="0";x.style.bottom="0";el.appendChild(x)});a.style.background="linear-gradient(90deg,#f0f0f0,#fafafa)";b.style.backgroundImage="radial-gradient(#999 2px, transparent 2px)";b.style.backgroundSize="20px 20px";c.style.background="";const onMove=e=>{const r=el.getBoundingClientRect();const mx=(e.clientX-r.left)/r.width-0.5;const my=(e.clientY-r.top)/r.height-0.5;a.style.transform=`translate(${mx*6}px,${my*4}px)`;b.style.transform=`translate(${mx*12}px,${my*8}px)`};el.onmousemove=onMove;function loop(){rafId=requestAnimationFrame(loop)}loop()}function stopParallax(){const el=q("#nano-stage");el.onmousemove=null;cancelAnimationFrame(rafId);rafId=null;el.innerHTML=""}async function saveScenarioToSelectedShape(json){return PowerPoint.run(async ctx=>{const shapes=ctx.presentation.getSelectedShapes();shapes.load("items");await ctx.sync();if(!shapes.items||shapes.items.length===0)throw new Error("No shape selected");const s=shapes.items[0];s.altTextDescription=JSON.stringify(json);await ctx.sync();return true})}async function loadScenarioFromSelectedShape(){return PowerPoint.run(async ctx=>{const shapes=ctx.presentation.getSelectedShapes();shapes.load("items");await ctx.sync();if(!shapes.items||shapes.items.length===0)throw new Error("No shape selected");const s=shapes.items[0];const raw=s.altTextDescription||"";await ctx.sync();if(!raw)throw new Error("Empty AltText");return JSON.parse(raw)})}async function onSaveScenario(){const scn=scenarioFromInputs();try{await saveScenarioToSelectedShape(scn)}catch(e){}}async function onLoadScenario(){try{const scn=await loadScenarioFromSelectedShape();q("#inp-tick").value=String(scn.params?.tickMs??100);q("#inp-factory").value=String((scn.nodes||[]).find(x=>x.type==="producer")?.rate??5);q("#inp-warehouse").value=String((scn.nodes||[]).find(x=>x.type==="buffer")?.capacity??50);q("#inp-store").value=String((scn.nodes||[]).find(x=>x.type==="consumer")?.rate??4);q("#inp-dfw").value=String((scn.edges||[]).find(e=>e.from==="factory"&&e.to==="warehouse")?.delay??2);q("#inp-dws").value=String((scn.edges||[]).find(e=>e.from==="warehouse"&&e.to==="store")?.delay??1);applyInputs();engine.loadScenario(scn)}catch(e){}}function wire(){q("#btn-start").addEventListener("click",()=>engine.start());q("#btn-stop").addEventListener("click",()=>engine.stop());q("#btn-nano").addEventListener("click",toggleNano);q("#btn-save-slide").addEventListener("click",onSaveScenario);q("#btn-load-slide").addEventListener("click",onLoadScenario)}Office.onReady(()=>{initEngine();bindInputs();wire()});
